name: Cross-Repository Synchronization

on:
  push:
    branches: [ main ]
    paths:
      - 'packages/ai-core/**'
      - 'apps/library/**'
      - 'apps/mobile/**'
  schedule:
    # Daily sync at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  sync-prompt-language:
    name: Sync APL to Standalone Repository
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    env:
      PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

    steps:
    - name: Checkout main repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Skip APL sync when PAT is missing
      if: env.PERSONAL_ACCESS_TOKEN == ''
      run: echo "PERSONAL_ACCESS_TOKEN is not configured. Skipping APL sync."

    - name: Checkout APL repository
      if: env.PERSONAL_ACCESS_TOKEN != ''
      uses: actions/checkout@v4
      with:
        repository: frankxai/arcanea-prompt-language
        token: ${{ env.PERSONAL_ACCESS_TOKEN }}
        path: apl-repo

    - name: Sync AI Core to APL Repository
      if: env.PERSONAL_ACCESS_TOKEN != ''
      run: |
        # Remove old content (except README, package.json, etc.)
        cd apl-repo
        find . -name "*.ts" -not -path "./.git/*" -delete

        # Copy updated AI core content
        if [ -d ../packages/ai-core ]; then
          cp -r ../packages/ai-core/* .
        else
          echo "packages/ai-core not found. Skipping file sync."
        fi

        # Update version in package.json
        node -e "
          const pkg = require('./package.json');
          const version = pkg.version.split('.');
          version[2] = (parseInt(version[2]) + 1).toString();
          pkg.version = version.join('.');
          require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2));
        "

    - name: Commit and push changes
      if: env.PERSONAL_ACCESS_TOKEN != ''
      run: |
        cd apl-repo
        git config user.name "Arcanea Sync Bot"
        git config user.email "sync@arcanea.ai"
        git add .
        if git diff --staged --quiet; then
          echo "No changes to sync"
        else
          git commit -m "Sync from main repository - $(date)"
          git push
        fi

  sync-library-content:
    name: Sync Library to Standalone Repository
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    env:
      PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

    steps:
    - name: Checkout main repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Skip library sync when PAT is missing
      if: env.PERSONAL_ACCESS_TOKEN == ''
      run: echo "PERSONAL_ACCESS_TOKEN is not configured. Skipping library sync."

    - name: Checkout Library repository
      if: env.PERSONAL_ACCESS_TOKEN != ''
      uses: actions/checkout@v4
      with:
        repository: frankxai/arcanean-library
        token: ${{ env.PERSONAL_ACCESS_TOKEN }}
        path: library-repo

    - name: Sync Library Content
      if: env.PERSONAL_ACCESS_TOKEN != ''
      run: |
        cd library-repo

        # Sync app content (excluding node_modules)
        if [ -d ../apps/library ]; then
          rsync -av --delete --exclude=node_modules --exclude=.git --exclude=README.md --exclude=package.json ../apps/library/ .
        else
          echo "apps/library not found. Skipping file sync."
        fi

        # Update version
        node -e "
          const pkg = require('./package.json');
          const version = pkg.version.split('.');
          version[2] = (parseInt(version[2]) + 1).toString();
          pkg.version = version.join('.');
          require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2));
        "

    - name: Commit and push changes
      if: env.PERSONAL_ACCESS_TOKEN != ''
      run: |
        cd library-repo
        git config user.name "Arcanea Sync Bot"
        git config user.email "sync@arcanea.ai"
        git add .
        if git diff --staged --quiet; then
          echo "No changes to sync"
        else
          git commit -m "Sync library content from main repository - $(date)"
          git push
        fi

  trigger-deployments:
    name: Trigger Standalone Deployments
    runs-on: ubuntu-latest
    needs: [sync-prompt-language, sync-library-content]
    if: always() && (needs.sync-prompt-language.result == 'success' || needs.sync-library-content.result == 'success')

    steps:
    - name: Trigger APL Deployment
      if: needs.sync-prompt-language.result == 'success'
      run: |
        curl -X POST \
          -H "Authorization: token ${{ secrets.PERSONAL_ACCESS_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/frankxai/arcanea-prompt-language/dispatches \
          -d '{"event_type": "deploy"}'

    - name: Trigger Library Deployment
      if: needs.sync-library-content.result == 'success'
      run: |
        curl -X POST \
          -H "Authorization: token ${{ secrets.PERSONAL_ACCESS_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/frankxai/arcanean-library/dispatches \
          -d '{"event_type": "deploy"}'

  notify-status:
    name: Notify Sync Status
    runs-on: ubuntu-latest
    needs: [sync-prompt-language, sync-library-content, trigger-deployments]
    if: always()

    steps:
    - name: Create sync summary
      run: |
        echo "## Cross-Repository Sync Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **APL Sync**: ${{ needs.sync-prompt-language.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Library Sync**: ${{ needs.sync-library-content.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployments**: ${{ needs.trigger-deployments.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Sync Time**: $(date)" >> $GITHUB_STEP_SUMMARY
