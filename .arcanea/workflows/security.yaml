# Security Review Workflow
# Invoke with: /security-review [repo] [scope]

name: security-review
description: Comprehensive security audit workflow
guardian: Lyssandria
awakened: Endara
frequency: 396 Hz  # Foundation Gate

triggers:
  - command: "/security-review"
  - command: "/security-audit"
  - command: "/sec"

parameters:
  - name: repo
    type: string
    default: all
    options: [all, main, intelligence-os, platform]
  - name: scope
    type: string
    default: full
    options: [full, deps, code, infra, secrets]

context:
  workspace: "C:/Users/frank/arcanea-hub"
  severity_levels: [critical, high, medium, low, info]

steps:
  - id: banner
    action: display
    content: |
      ╔═══════════════════════════════════════════════════════════╗
      ║        SECURITY REVIEW - Foundation Gate (396 Hz)         ║
      ║              Guardian: Lyssandria                         ║
      ╚═══════════════════════════════════════════════════════════╝

  - id: dependency_scan
    condition: "{params.scope} in ['full', 'deps']"
    action: shell
    parallel: true
    commands:
      - name: "npm audit - main"
        cmd: "cd {workspace}/main && npm audit --json 2>/dev/null | head -100"
      - name: "npm audit - intelligence-os"
        cmd: "cd {workspace}/intelligence-os && npm audit --json 2>/dev/null | head -100"
      - name: "License check"
        cmd: "cd {workspace}/main && npx license-checker --summary 2>/dev/null || echo 'No license checker'"

  - id: secret_scan
    condition: "{params.scope} in ['full', 'secrets']"
    action: shell
    commands:
      - name: "Git secrets scan"
        cmd: |
          cd {workspace}
          grep -r --include="*.ts" --include="*.js" --include="*.env*" \
            -E "(api[_-]?key|secret|password|token|credential)" \
            --exclude-dir=node_modules --exclude-dir=.git \
            . 2>/dev/null | head -50 || echo "No obvious secrets found"

  - id: code_analysis
    condition: "{params.scope} in ['full', 'code']"
    action: ai_analysis
    guardian: Lyssandria
    prompt: |
      Analyze the codebase for security vulnerabilities:

      1. **Injection Risks**: SQL, NoSQL, command injection
      2. **XSS Vulnerabilities**: Unescaped user input
      3. **Authentication Issues**: Weak auth, session management
      4. **Data Exposure**: Sensitive data in logs, responses
      5. **CSRF Protection**: Missing tokens, improper validation
      6. **Security Headers**: Missing or misconfigured

      Focus on OWASP Top 10 categories.

  - id: infrastructure_review
    condition: "{params.scope} in ['full', 'infra']"
    action: ai_analysis
    guardian: Lyssandria
    prompt: |
      Review infrastructure security:

      1. **Environment Variables**: Are secrets properly managed?
      2. **Database Security**: Connection strings, access control
      3. **API Security**: Rate limiting, authentication
      4. **Cloud Config**: Supabase, Vercel settings
      5. **Network Security**: HTTPS, CORS configuration

  - id: compile_findings
    action: ai_synthesis
    guardian: Lyssandria
    awakened: Endara
    inputs:
      - dependency_scan
      - secret_scan
      - code_analysis
      - infrastructure_review
    prompt: |
      Compile all security findings into a structured report:

      1. **Critical Issues** (must fix immediately)
      2. **High Severity** (fix within 24 hours)
      3. **Medium Severity** (fix within 1 week)
      4. **Low Severity** (fix within 1 month)
      5. **Recommendations** (best practices)

      For each issue, provide:
      - Description
      - Location (file/line if applicable)
      - Impact assessment
      - Remediation steps

  - id: generate_report
    action: write_file
    path: "{workspace}/.arcanea/security/report-{date}.md"
    content: |
      # Security Review Report

      **Date:** {date}
      **Scope:** {params.scope}
      **Repository:** {params.repo}
      **Guardian:** Lyssandria (Foundation Gate - 396 Hz)

      ---

      ## Executive Summary

      {compile_findings.summary}

      ## Detailed Findings

      {compile_findings.details}

      ## Remediation Plan

      {compile_findings.remediation}

      ---

      *Report generated by Arcanea Security Review*
      *Guardian Lyssandria protects the Foundation*

outputs:
  - file: "{workspace}/.arcanea/security/report-{date}.md"
  - display: terminal
  - alert_if: "{compile_findings.critical_count} > 0"
