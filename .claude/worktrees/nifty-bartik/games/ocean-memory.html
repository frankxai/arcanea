<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ocean Memory - Arcanea Deep Sea Explorer</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    <style>
        :root {
            --water-primary: #4fc3f7;
            --water-dark: #01579b;
            --water-glow: #80d8ff;
            --gold-light: #ffd700;
            --gold-medium: #ffb300;
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-elevated: #1a1a28;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --text-muted: #606070;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
            touch-action: none;
        }

        .game-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(180deg, var(--bg-card) 0%, transparent 100%);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1.25rem;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: var(--water-primary);
            border-color: var(--water-primary);
        }

        .game-title {
            font-family: 'Cinzel', serif;
            font-size: 1.25rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--water-primary), var(--gold-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-pill {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 0.875rem;
        }

        .stat-value {
            font-weight: 600;
            color: var(--gold-light);
        }

        #game-container {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, #0a0a0f 0%, #001529 50%, #0a0a0f 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-ocean {
            width: 150px;
            height: 150px;
            position: relative;
            margin-bottom: 2rem;
        }

        .bubble {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(79, 195, 247, 0.8), rgba(1, 87, 155, 0.4));
            animation: bubbleRise 3s ease-in-out infinite;
        }

        .bubble:nth-child(1) { width: 20px; height: 20px; left: 30px; bottom: 0; animation-delay: 0s; }
        .bubble:nth-child(2) { width: 15px; height: 15px; left: 60px; bottom: 0; animation-delay: 0.5s; }
        .bubble:nth-child(3) { width: 25px; height: 25px; left: 90px; bottom: 0; animation-delay: 1s; }
        .bubble:nth-child(4) { width: 18px; height: 18px; left: 45px; bottom: 0; animation-delay: 1.5s; }

        @keyframes bubbleRise {
            0% { transform: translateY(0) scale(1); opacity: 0.6; }
            50% { transform: translateY(-75px) scale(1.1); opacity: 1; }
            100% { transform: translateY(-150px) scale(0.8); opacity: 0; }
        }

        .loading-text {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--water-primary);
            margin-bottom: 0.5rem;
        }

        .agent-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 2px solid var(--water-primary);
            border-radius: 16px;
            padding: 1rem;
            z-index: 50;
            display: none;
            box-shadow: 0 0 30px rgba(79, 195, 247, 0.3);
            animation: slideUp 0.3s ease;
        }

        .agent-panel.active { display: block; }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .agent-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .agent-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--water-primary), var(--gold-light));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .agent-name {
            font-weight: 600;
            color: var(--water-primary);
        }

        .agent-role {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .agent-message {
            color: var(--text-secondary);
            line-height: 1.5;
            font-size: 0.9375rem;
        }

        .agent-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.25rem;
        }

        .discovery-panel {
            position: fixed;
            top: 70px;
            right: 10px;
            width: 300px;
            max-height: calc(100vh - 100px);
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1rem;
            z-index: 40;
            display: none;
            overflow-y: auto;
        }

        .discovery-panel.active { display: block; }

        .discovery-header {
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            margin-bottom: 1rem;
            color: var(--water-primary);
        }

        .discovery-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .discovery-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-elevated);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .discovery-item.found {
            border-color: var(--gold-light);
            background: rgba(255, 215, 0, 0.1);
        }

        .discovery-icon {
            font-size: 1.5rem;
        }

        .discovery-name {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .discovery-lore {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 150;
            display: none;
        }

        .modal-overlay.active { display: block; }

        .discovery-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--bg-card);
            border: 2px solid var(--gold-light);
            border-radius: 24px;
            padding: 2rem;
            text-align: center;
            z-index: 200;
            display: none;
            box-shadow: 0 0 60px rgba(255, 215, 0, 0.3);
            max-width: 450px;
            width: 90%;
        }

        .discovery-modal.active {
            display: block;
            animation: modalPop 0.5s ease forwards;
        }

        @keyframes modalPop {
            to { transform: translate(-50%, -50%) scale(1); }
        }

        .discovery-image {
            font-size: 5rem;
            margin-bottom: 1rem;
            animation: pulse 2s ease infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .discovery-title {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--gold-light);
            margin-bottom: 0.5rem;
        }

        .discovery-quote {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.125rem;
            font-style: italic;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .xp-reward {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid var(--gold-light);
            border-radius: 50px;
            font-family: 'Cinzel', serif;
            font-size: 1.25rem;
            color: var(--gold-light);
            margin-bottom: 1.5rem;
        }

        .success-btn {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--gold-light), var(--gold-medium));
            border: none;
            border-radius: 12px;
            color: #000;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .success-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.3);
        }

        @media (max-width: 768px) {
            .game-title { font-size: 1rem; }
            .stat-pill { padding: 0.375rem 0.75rem; font-size: 0.75rem; }
            .agent-panel { left: 10px; right: 10px; bottom: 10px; }
            .discovery-panel { width: calc(100vw - 20px); right: 10px; left: 10px; }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-ocean">
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
        </div>
        <div class="loading-text">Ocean Memory</div>
        <div class="loading-subtext">Diving into the depths...</div>
    </div>

    <header class="game-header">
        <div class="header-left">
            <button class="back-btn" onclick="goBack()">‚Üê</button>
            <div class="game-title">üêã Ocean Memory</div>
        </div>
        <div class="header-right">
            <div class="stat-pill">
                <span class="stat-icon">‚≠ê</span>
                <span class="stat-value" id="xpDisplay">0</span>
            </div>
            <div class="stat-pill">
                <span class="stat-icon">üíé</span>
                <span class="stat-value" id="fragmentsDisplay">0</span>
            </div>
            <button class="back-btn" onclick="toggleDiscoveryPanel()" style="font-size: 1rem;">üìú</button>
        </div>
    </header>

    <div id="game-container"></div>

    <div class="discovery-panel" id="discoveryPanel">
        <div class="discovery-header">üìú Memory Fragments</div>
        <div class="discovery-list" id="discoveryList"></div>
    </div>

    <div class="agent-panel" id="agentPanel">
        <button class="agent-close" onclick="closeAgentPanel()">√ó</button>
        <div class="agent-header">
            <div class="agent-avatar" id="agentAvatar">üêã</div>
            <div>
                <div class="agent-name" id="agentName">Ocean-Memory</div>
                <div class="agent-role" id="agentRole">The Deep Rememberer</div>
            </div>
        </div>
        <div class="agent-message" id="agentMessage">
            Welcome to the deep. Use arrow keys or touch to swim. Collect glowing memory fragments to uncover ancient secrets. Explore the ruins and discover what lies beneath.
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="discovery-modal" id="discoveryModal">
        <div class="discovery-image" id="discoveryImage">üèõÔ∏è</div>
        <div class="discovery-title" id="discoveryTitle">Ancient Ruins</div>
        <div class="discovery-quote" id="discoveryQuote">
            "In the silence of the deep, the ocean remembers what the world has forgotten."
        </div>
        <div class="xp-reward">
            <span>‚≠ê</span>
            <span id="discoveryXP">+100 XP</span>
        </div>
        <button class="success-btn" onclick="closeDiscoveryModal()">Continue Exploring</button>
    </div>

    <script>
        const GameState = {
            xp: 0,
            fragments: 0,
            totalFragments: 12,
            discovered: [],
            playerX: 0,
            playerY: 0,
            worldSize: 2000,
            bioluminescence: 0
        };

        const DISCOVERIES = [
            { id: 1, icon: 'üèõÔ∏è', name: 'Atlantean Temple', lore: 'A temple from the lost city, its pillars still standing after millennia.', quote: 'The gods of the deep do not forget their worshippers.' },
            { id: 2, icon: '‚öì', name: 'Sunken Anchor', lore: 'A massive iron anchor from a ship lost centuries ago.', quote: 'Even the mightiest vessels must eventually rest.' },
            { id: 3, icon: 'üóø', name: 'Ancient Statue', lore: 'A weathered face, eternally watching the currents.', quote: 'Stone remembers when flesh has long decayed.' },
            { id: 4, icon: 'üíÄ', name: 'Whale Graveyard', lore: 'The final resting place of ocean giants.', quote: 'From death comes life, feeding the depths for generations.' },
            { id: 5, icon: 'üìú', name: 'Waterlogged Scroll', lore: 'A message in a bottle, never received.', quote: 'Words survive, even when their readers are gone.' },
            { id: 6, icon: '‚ö±Ô∏è', name: 'Ceremonial Urn', lore: 'An urn containing the ashes of a forgotten king.', quote: 'All thrones eventually sink to the same level.' },
            { id: 7, icon: 'üî±', name: 'Triton\'s Trident', lore: 'A legendary weapon of the sea lords.', quote: 'Power corrodes, even in salt water.' },
            { id: 8, icon: 'üëë', name: 'Coral Crown', lore: 'A crown reclaimed by the reef.', quote: 'Nature adorns what humans once prized.' },
            { id: 9, icon: 'üïØÔ∏è', name: 'Eternal Flame', lore: 'A bioluminescent flame that never extinguishes.', quote: 'Light in the darkest depths, hope in despair.' },
            { id: 10, icon: 'üß≠', name: 'Compass Rose', lore: 'A navigator\'s tool, still pointing north.', quote: 'Direction remains, even when destination is lost.' },
            { id: 11, icon: 'üé≠', name: 'Theater Mask', lore: 'A mask from an underwater performance hall.', quote: 'The final act played to an audience of fish.' },
            { id: 12, icon: 'üíé', name: 'Heart of the Ocean', lore: 'A gem of impossible blue, the ocean\'s soul.', quote: 'The deepest treasure is the sea itself.' }
        ];

        const config = {
            type: Phaser.AUTO,
            parent: 'game-container',
            width: window.innerWidth,
            height: window.innerHeight - 60,
            backgroundColor: '#001529',
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 },
                    drag: 0.95,
                    debug: false
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            },
            scale: {
                mode: Phaser.Scale.RESIZE,
                autoCenter: Phaser.Scale.CENTER_BOTH
            }
        };

        let game;
        let player;
        let cursors;
        let fragmentsGroup;
        let ruinsGroup;
        let particles;
        let bioluminescentLights = [];

        window.addEventListener('load', () => {
            game = new Phaser.Game(config);
            initDiscoveryPanel();
            loadProgress();
            
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
                showAgentMessage('Ocean-Memory', 'The Deep Rememberer', 'üêã',
                    'Welcome to the depths, explorer. Swim using arrow keys or touch. Collect the glowing memory fragments to uncover ancient stories. The ocean holds many secrets...');
            }, 2500);
        });

        function preload() {
            const graphics = this.make.graphics();
            
            // Diver/player
            graphics.fillStyle(0x4fc3f7);
            graphics.fillCircle(16, 16, 12);
            graphics.fillStyle(0x80d8ff);
            graphics.fillCircle(12, 12, 4);
            graphics.generateTexture('diver', 32, 32);
            graphics.clear();

            // Memory fragment
            graphics.fillStyle(0xffd700);
            graphics.fillCircle(12, 12, 10);
            graphics.fillStyle(0xffffff);
            graphics.fillCircle(8, 8, 3);
            graphics.generateTexture('fragment', 24, 24);
            graphics.clear();

            // Ruins
            graphics.fillStyle(0x2a3a4a);
            graphics.fillRect(0, 0, 80, 100);
            graphics.fillStyle(0x1a2a3a);
            graphics.fillRect(10, 10, 20, 30);
            graphics.fillRect(50, 10, 20, 30);
            graphics.fillRect(30, 50, 20, 40);
            graphics.generateTexture('ruins', 80, 100);
            graphics.clear();

            // Coral
            graphics.fillStyle(0xff6b9d);
            graphics.fillCircle(10, 30, 8);
            graphics.fillCircle(20, 20, 10);
            graphics.fillCircle(30, 35, 7);
            graphics.generateTexture('coral', 40, 40);
            graphics.clear();

            // Bubble particle
            graphics.fillStyle(0x80d8ff);
            graphics.fillCircle(4, 4, 3);
            graphics.generateTexture('bubble', 8, 8);
            graphics.clear();
        }

        function create() {
            const worldSize = GameState.worldSize;
            this.physics.world.setBounds(0, 0, worldSize, worldSize);

            // Create deep ocean background
            const bg = this.add.graphics();
            for (let y = 0; y < worldSize; y += 100) {
                const darkness = Math.min(1, y / worldSize);
                const color = Phaser.Display.Color.Interpolate.ColorWithColor(
                    { r: 0, g: 21, b: 41 },
                    { r: 2, g: 5, b: 10 },
                    100,
                    darkness * 100
                );
                bg.fillStyle(Phaser.Display.Color.GetColor(color.r, color.g, color.b));
                bg.fillRect(0, y, worldSize, 100);
            }

            // Create ruins scattered throughout
            ruinsGroup = this.physics.add.staticGroup();
            for (let i = 0; i < 15; i++) {
                const x = Phaser.Math.Between(100, worldSize - 100);
                const y = Phaser.Math.Between(200, worldSize - 200);
                const ruin = ruinsGroup.create(x, y, 'ruins');
                ruin.setScale(0.8 + Math.random() * 0.4);
                ruin.setAlpha(0.6 + Math.random() * 0.3);
            }

            // Create coral
            for (let i = 0; i < 30; i++) {
                const x = Phaser.Math.Between(50, worldSize - 50);
                const y = Phaser.Math.Between(100, worldSize - 50);
                const coral = this.add.image(x, y, 'coral');
                coral.setScale(0.5 + Math.random() * 0.5);
                coral.setAlpha(0.7);
            }

            // Create player
            player = this.physics.add.sprite(worldSize / 2, 100, 'diver');
            player.setCollideWorldBounds(true);
            player.setDrag(200);
            player.setDamping(true);

            // Camera
            this.cameras.main.startFollow(player, true, 0.1, 0.1);
            this.cameras.main.setZoom(1);
            this.cameras.main.setBounds(0, 0, worldSize, worldSize);

            // Create fragments
            fragmentsGroup = this.physics.add.group();
            DISCOVERIES.forEach((discovery, index) => {
                const x = Phaser.Math.Between(200, worldSize - 200);
                const y = Phaser.Math.Between(300 + (index * 100), worldSize - 100);
                const fragment = fragmentsGroup.create(x, y, 'fragment');
                fragment.setData('id', discovery.id);
                fragment.setData('discovery', discovery);
                
                // Add floating animation
                this.tweens.add({
                    targets: fragment,
                    y: y + 20,
                    duration: 2000 + Math.random() * 1000,
                    yoyo: true,
                    repeat: -1,
                    ease: 'Sine.easeInOut'
                });

                // Add light glow
                const light = this.add.pointlight(x, y, 0xffd700, 100, 0.5);
                bioluminescentLights.push(light);
            });

            // Input
            cursors = this.input.keyboard.createCursorKeys();

            // Touch controls
            this.input.on('pointermove', (pointer) => {
                if (pointer.isDown) {
                    const angle = Phaser.Math.Angle.Between(player.x, player.y, pointer.worldX, pointer.worldY);
                    const speed = 200;
                    player.setVelocity(Math.cos(angle) * speed, Math.sin(angle) * speed);
                }
            });

            // Collisions
            this.physics.add.overlap(player, fragmentsGroup, collectFragment, null, this);
            this.physics.add.collider(player, ruinsGroup);

            // Bubble particles
            particles = this.add.particles(0, 0, 'bubble', {
                speed: { min: 20, max: 50 },
                scale: { start: 0.5, end: 0 },
                blendMode: 'ADD',
                lifespan: 3000,
                frequency: 200,
                quantity: 1
            });

            // Resize handler
            this.scale.on('resize', (gameSize) => {
                this.cameras.main.setViewport(0, 0, gameSize.width, gameSize.height);
            });
        }

        function update(time, delta) {
            // Keyboard controls
            const speed = 200;
            
            if (cursors.left.isDown) {
                player.setVelocityX(-speed);
            } else if (cursors.right.isDown) {
                player.setVelocityX(speed);
            }

            if (cursors.up.isDown) {
                player.setVelocityY(-speed);
            } else if (cursors.down.isDown) {
                player.setVelocityY(speed);
            }

            // Emit bubbles
            if (Math.random() < 0.05) {
                particles.emitParticleAt(player.x, player.y);
            }

            // Update lights to follow fragments
            fragmentsGroup.children.entries.forEach((fragment, index) => {
                if (bioluminescentLights[index] && fragment.active) {
                    bioluminescentLights[index].x = fragment.x;
                    bioluminescentLights[index].y = fragment.y;
                }
            });

            // Depth-based lighting
            const depth = player.y / GameState.worldSize;
            GameState.bioluminescence = depth;
        }

        function collectFragment(player, fragment) {
            const discovery = fragment.getData('discovery');
            
            if (!GameState.discovered.includes(discovery.id)) {
                GameState.discovered.push(discovery.id);
                GameState.fragments++;
                
                const xpGain = 100;
                GameState.xp += xpGain;
                
                // Show discovery modal
                showDiscoveryModal(discovery, xpGain);
                
                // Agent message
                showAgentMessage('Ocean-Memory', 'The Deep Rememberer', 'üêã',
                    `${discovery.name} discovered! ${discovery.lore}`);
                
                updateDisplays();
                saveProgress();
                updateDiscoveryPanel();
                
                syncWithArcanea(xpGain, 'fragment_collected');
            }
            
            // Remove light
            const index = fragmentsGroup.children.entries.indexOf(fragment);
            if (bioluminescentLights[index]) {
                bioluminescentLights[index].destroy();
            }
            
            fragment.destroy();
        }

        function showDiscoveryModal(discovery, xp) {
            document.getElementById('discoveryImage').textContent = discovery.icon;
            document.getElementById('discoveryTitle').textContent = discovery.name;
            document.getElementById('discoveryQuote').textContent = `"${discovery.quote}"`;
            document.getElementById('discoveryXP').textContent = `+${xp} XP`;
            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('discoveryModal').classList.add('active');
        }

        function closeDiscoveryModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.getElementById('discoveryModal').classList.remove('active');
        }

        function initDiscoveryPanel() {
            updateDiscoveryPanel();
        }

        function updateDiscoveryPanel() {
            const list = document.getElementById('discoveryList');
            list.innerHTML = '';
            
            DISCOVERIES.forEach(discovery => {
                const item = document.createElement('div');
                item.className = 'discovery-item' + (GameState.discovered.includes(discovery.id) ? ' found' : '');
                item.innerHTML = `
                    <div class="discovery-icon">${discovery.icon}</div>
                    <div>
                        <div class="discovery-name">${discovery.name}</div>
                        ${GameState.discovered.includes(discovery.id) ? `<div class="discovery-lore">${discovery.lore}</div>` : '<div class="discovery-lore">???</div>'}
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function toggleDiscoveryPanel() {
            document.getElementById('discoveryPanel').classList.toggle('active');
        }

        function updateDisplays() {
            document.getElementById('xpDisplay').textContent = GameState.xp.toLocaleString();
            document.getElementById('fragmentsDisplay').textContent = `${GameState.fragments}/${GameState.totalFragments}`;
        }

        function showAgentMessage(name, role, avatar, message) {
            document.getElementById('agentName').textContent = name;
            document.getElementById('agentRole').textContent = role;
            document.getElementById('agentAvatar').textContent = avatar;
            document.getElementById('agentMessage').textContent = message;
            document.getElementById('agentPanel').classList.add('active');
            
            setTimeout(() => {
                closeAgentPanel();
            }, 6000);
        }

        function closeAgentPanel() {
            document.getElementById('agentPanel').classList.remove('active');
        }

        function goBack() {
            window.location.href = '../games-v2.html';
        }

        function saveProgress() {
            const data = {
                xp: GameState.xp,
                fragments: GameState.fragments,
                discovered: GameState.discovered
            };
            localStorage.setItem('oceanMemoryData', JSON.stringify(data));
        }

        function loadProgress() {
            const saved = localStorage.getItem('oceanMemoryData');
            if (saved) {
                const data = JSON.parse(saved);
                GameState.xp = data.xp || 0;
                GameState.fragments = data.fragments || 0;
                GameState.discovered = data.discovered || [];
                updateDisplays();
            }
        }

        function syncWithArcanea(xp, reason) {
            if (window.Arcanea && window.Arcanea.awardXP) {
                window.Arcanea.awardXP({
                    gameId: 'ocean-memory',
                    amount: xp,
                    reason: reason,
                    agent: '@ocean-memory'
                });
            }
            
            window.dispatchEvent(new CustomEvent('oceanMemoryProgress', {
                detail: { xp, fragments: GameState.fragments, timestamp: Date.now() }
            }));
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeAgentPanel();
                document.getElementById('discoveryPanel').classList.remove('active');
                closeDiscoveryModal();
            }
            if (e.key === 'p' || e.key === 'P') {
                toggleDiscoveryPanel();
            }
        });

        // Prevent double-tap zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>
